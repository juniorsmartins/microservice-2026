spring:
  application:
    name: api-users


  # --------------------------------------------------
  # Config de API Versioning
  # --------------------------------------------------
  mvc:
    apiversion:
      supported: 1.0,2.0
      default: 1.0
      use:
        path-segment: 1
  # --------------------------------------------------


  # --------------------------------------------------
  # Config de Config Server Client
  # --------------------------------------------------
  config:
    import: optional:configserver:${SPRING_CLOUD_CONFIG_SERVER_URI:http://localhost:8888}
  cloud:
    config:
      enabled: false
    discovery:
      enabled: false
  # --------------------------------------------------


  datasource: # Configura o datasource do banco de dados.
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE # Define a URL de conexão ao banco.
    username: sa
    password:


    # --------------------------------------------------
    # Config de Pool de Conexões
    # --------------------------------------------------
    hikari:
      autoCommit: false
      pool-name: ${spring.application.name}-hikariPool
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 3000
      validation-timeout: 5000
      connection-test-query: SELECT 1
      keepalive-time: 300000
      isolate-internal-queries: true
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        useLocalSessionState: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false
    # --------------------------------------------------


  # --------------------------------------------------
  # Config de JPA
  # --------------------------------------------------
  jpa:
    database: H2
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: create-drop
    defer-datasource-initialization: true
    show-sql: true
    properties:
      org:
        hibernate:
          envers:
            audit_table_name: revision_info
            audit_table_suffix: _audit
            revision_field_name: revision_id
            revision_type_field_name: revision_type
  # --------------------------------------------------


  sql: # Habilita ou desabilita acionamento de script SQL
    init:
      mode: never
      data-locations: []

  # Habilitar o console do H2 (opcional)
  h2:
    console:
      enabled: true
      path: /h2-console


  # --------------------------------------------------
  # Config de Liquibase
  # --------------------------------------------------
  liquibase:
    enabled: false
  # --------------------------------------------------


  # --------------------------------------------------
  # Config de Kafka
  # --------------------------------------------------
  kafka:
    bootstrap-servers: ${spring.embedded.kafka.brokers} # Usa broker embutido
    schema.registry.url: mock://localhost

    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: io.confluent.kafka.serializers.KafkaAvroSerializer

      # === Exactly-once (trio sagrado: idempotence, acks e retries) ===
      acks: 0
      enable.idempotence: false
      max.in.flight.requests.per.connection: 5
      retries: 0

      # === Resiliência (funciona com o Retries) ===
      retry.backoff.ms: 100
      retry.backoff.max.ms: 1000
      request.timeout.ms: 30000
      delivery.timeout.ms: 120000

      # === Throughput Máximo ===
      batch-size: 131072
      linger-ms: 5
      compression-type: zstd

      properties:
        auto.register.schemas: true
        schema.registry.url: mock://localhost

    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: io.confluent.kafka.serializers.KafkaAvroDeserializer

      # === Estratégia de rebalance ===
      partition.assignment.strategy: org.apache.kafka.clients.consumer.CooperativeStickyAssignor
      group-id: api-users-v1
      group.instance.id: api-users-0
      session.timeout.ms: 45000

      # === Forma de leitura e garantia de entrega ===
      auto-offset-reset: latest
      enable-auto-commit: false

      # === Resiliência (funciona com Retries) ===
      request-timeout-ms: 45000

      # === Performance ===
      max-poll-records: 500
      max.poll.interval.ms: 600000

      # === Schema Registry ===
      properties:
        specific.avro.reader: true
        schema.registry.url: mock://localhost

    topic:
      events:
        customer-created: events.customer-created-test
      min.insync.replicas: 0
  # --------------------------------------------------


  # --------------------------------------------------
  # Config de actuator
  # --------------------------------------------------
management:
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: refresh,health,info,metrics,configprops,liquibase
  endpoint:
    health:
      show-details: always
    configprops:
      show-values: always
  # --------------------------------------------------


  # --------------------------------------------------
  # Config de Eureka Client
  # --------------------------------------------------
eureka:
  client:
    enabled: false
  # --------------------------------------------------

